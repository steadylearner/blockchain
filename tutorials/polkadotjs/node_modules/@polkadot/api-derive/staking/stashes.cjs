"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.stashes = stashes;

var _operators = require("@polkadot/x-rxjs/operators");

var _index = require("../util/index.cjs");

// Copyright 2017-2021 @polkadot/api-derive authors & contributors
// SPDX-License-Identifier: Apache-2.0
function onBondedEvent(api) {
  let current = Date.now();
  return api.query.system.events().pipe((0, _operators.map)(events => {
    current = events.filter(({
      event,
      phase
    }) => {
      try {
        return phase.isApplyExtrinsic && event.section === 'staking' && event.method === 'Bonded';
      } catch {
        return false;
      }
    }) ? Date.now() : current;
    return current;
  }), (0, _operators.startWith)(current), (0, _index.drr)({
    skipTimeout: true
  }));
}
/**
 * @description Retrieve the list of all validator stashes
 */


function stashes(instanceId, api) {
  return (0, _index.memo)(instanceId, () => onBondedEvent(api).pipe((0, _operators.switchMap)(() => api.query.staking.validators.keys()), (0, _operators.map)(keys => keys.map(({
    args: [validatorId]
  }) => validatorId).filter(a => a))));
}